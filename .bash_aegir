#!/bin/sh
# .bash_aegir
# To include this in your .bash environment add this to your .bashrc file (removing ##):
###-------------------------------------------------------------
### Aegir specific
###-------------------------------------------------------------
##if [ -f ~/.bash_aegir ]; then
##  . ~/.bash_aegir # --> Read ~/.bash_aegir if present
##fi

#-----------------------------------------------------------
#Aegir user related aliases
#-----------------------------------------------------------
#Note: for alias that will sudo -u add a space to the end of the alias to check for alias substitutions. i.e. using your aliases while using sudo
alias suaegir="CMDINFO echo 'suaegir => sudo -u aegir ' > /dev/tty; NORMAL sudo -u aegir "

#-----------------------------------------------------------
#drush related aliases
#-----------------------------------------------------------
alias adrush="CMDINFO echo 'adrush => suaegir drush ' > /dev/tty; NORMAL suaegir drush "
alias drush="CMDINFO echo 'drush => ' > /dev/tty; NORMAL adrush " #run all drush calls through aegir user

#-----------------------------------------------------------
#git aegir aliases
#-----------------------------------------------------------
alias agit="CMDINFO echo 'agit => suaegir git ' > /dev/tty; NORMAL suaegir git " #git as the aegir user
alias git="CMDINFO echo -n 'git => ' > /dev/tty; NORMAL agit " #run all git calls through the aegir user

#Aegir usage aliases
alias noAegirSilent="alias git=\"git\"; alias drush=\"drush\""; #restore normal git/drush usage during a session (w/o tty feedback)
alias noAegir="INFO echo '#No sudo -u aegir: git => git, drush => drush;' > /dev/tty; echo '#You can also prepend git/drush cmds with \' > /dev/tty; echo '#Use alias useAegir to re-enable aegir alias ' > /dev/tty; echo -n > /dev/tty; NORMAL noAegirSilent"; #restore normal git/drush usage during a session
alias useAegir="INFO echo 'useAegir => alias git=\'agit\'; alias drush=\'adrush\'; > /dev/tty; echo '#use alias noAegir to disable ' > /dev/tty; echo -n > /dev/tty; NORMAL alias git=\"agit\"; alias drush=\"adrush\""; #restore aegir git/drush usage during a session

#noAegirSilent; #for noAegir branch

#-----------------------------------------------------------
#aegir aliases
#-----------------------------------------------------------
alias aliases_aegir="INFO echo '### Available Aegir Functions (.bash_aegir) ###'; NORMAL echo -n; cat ~/.bash_aegir | grep function; echo -n; INFO echo '### Aegir aliases (.bash_aegir) ###:'; NORMAL echo -n; cat ~/.bash_aegir | grep alias; echo -n; "

#-----------------------------------------------------------
#drush related functions
#-----------------------------------------------------------

#Test bash options:
function testBash(){
#!/bin/bash
OPTIND=1
function print_help { echo "Usage" >&2 ; } 

while getopts ":vtrsc" name; do
    case $name in
        v) VALIDATE=1;;
        t) TEST=1;;
        r) REPORT=1;;
        s) SYNC=1;;
        c) CLEAR=1;;
        ?) print_help; 
        ;;
    esac
done

echo "OPTIND: $OPTIND"
echo ${#@}

shift $((OPTIND - 1))

while (( "$#" )); do
    if [[ $1 == -* ]] ; then
        echo "All opts up front, please." >&2 ; print_help ; 
    fi
    echo $1
    shift
done
}


function testOpts(){
#!/bin/bash
OPTIND=1

  while getopts ":a:b:cde:f:g:" opt; do

    case $opt in
      a)
        echo "[getopts:$OPTIND]==> -$opt"
        echo "help" >&2
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
      b)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
      c)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
      d)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
      e)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
      f)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
      g)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;

      \?)
        echo "Invalid option: -$OPTARG" >&2
        ;;
      :)
        echo "Option -$OPTARG requires an argument." >&2
        ;;
    esac

  done 
  echo "optind: $OPTIND" >&2
  shift $((OPTIND-1))
  echo "optind: $OPTIND" >&2
  echo "[otheropts]==> $@"
} 

function testOpts2(){
#!/bin/bash
OPTIND=1

  while getopts ":ab" opt; do
    case $opt in
      a)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
      b)
        echo "Parsing option: '-${opt}', Parameter: $OPTARG" >&2
        ;;
    esac
  done
  

  echo "optind: $OPTIND" >&2
  shift $((OPTIND-1))

}

#--------------------------------
# Drush drushverify function
#--------------------------------
function drushverify(){ # Aegir via Drush - verify a site. Usage: drushverify [-h -v] drushSiteAlias. Ex: $ drushverify hr.uoregon.edu = "drush provision-verify @hr.uoregon.edu; drush @hostmaster hosting-task @hr.uoregon.edu verify
  #!/bin/sh
  # Arguments = [-h (help) -v (verbose)]

  # Credit: Bash HEREDOC usage() and getops while loop: http://rsalveti.wordpress.com/2007/04/03/bash-parsing-arguments-with-getopts/

  usage()
  {
  cat << EOF
  usage: $0 options

  function: drushverify

  This script triggers a provision verify on the local file system and initates a remote site verification for a specified site. Useful for running Aegir verify from the terminal
  Note: do not include @ symbol. 

  Usage: drushverify [-v] drushSiteAlias

  Example: drushverify hr.uoregon.edu
    Cmd line result: 
      $ drush provision-verify @hr.uoregon.edu
      $ drush @hostmaster hosting-task @hr.uoregon.edu verify

  OPTIONS:
     -v               -   Verbose
     -h               -   Help

  ARGUMENTS:
    drushSiteAlias    -   The drush site alias (with out '@') 
EOF
  }

  #### Options ####
  OPTIND=1
  # Set empty VERBOSE
  VERBOSE=
  HELP=0
  # Check for options. (currently in a while loop and case statement for potential expansion)
  while getopts ":hv" OPTION; 
  do
    case $OPTION in
      h) 
        # Help
        HELP=1
        INFO echo "Testing: setting HELP: $HELP" > /dev/tty; NORMAL
        break
        ;;
      v) # Verbose
        VERBOSE=" -v"
        INFO echo "Testing: setting Verbose: $VERBOSE" > /dev/tty; NORMAL
        ;;
      ?) #if no option is given continue on
        INFO echo "Unknown option: -$OPTARG" > /dev/tty; NORMAL
        ;;
    esac
  done

  INFO echo "Testing: Verbose: $VERBOSE" > /dev/tty; NORMAL
  
  #### Args ####
  #Credit; tip on combining options with args: Thanks to http://stackoverflow.com/questions/11742996/shell-script-is-mixing-getopts-with-positional-parameters-possible
  # If there are options (-h v) then set arg 1 to the first var after those options
  ARG1=${@:$OPTIND:1}
  #ARG2=${@:$OPTIND+1:1}
  CMDINFO echo "ARG1: $ARG1" > /dev/tty; NORMAL

  # testing show args
  INFO echo "args: all args (\$*) passed to me -\"$*\"" > /dev/tty; NORMAL
  INFO echo "ARG1: $ARG1" > /dev/tty; NORMAL
  INFO echo "Number of args: $#" > /dev/tty; NORMAL

  #if there are no options then arg1 = $1 if it doesn't start with '-'
  if [ ! -n "$ARG1" ] && [[ $1 != -* ]] && [[ $# -gt 0 ]] ; then
    ARG1=$1
    CMDINFO echo "Testing: No Options past. ARG1 = \$1: $ARG1" > /dev/tty; NORMAL
  fi

  #check for --help
  if [[ $1 == "--help" ]] ; then
    HELP=1
  fi

  INFO echo "HELP: $HELP" > /dev/tty; NORMAL
#If no ARG1 or ARG1 starts with a '-' then show usage, else execute script
  if [ ! -n "$ARG1" ] || [[ $ARG1 == -* ]] || (($HELP)) ; then 
    INFO echo "Testing: If no ARG1 or ARG1 starts with a '-' OR HELP = 1 then show usage, else execute script" > /dev/tty; NORMAL
    usage
    #return
  else
    CMD1="@$ARG1 provision-verify$VERBOSE"
    CMDINFO echo "drush $CMD1" > /dev/tty; NORMAL
    drush $CMD1

    CMD2="drush @hostmaster hosting-task$VERBOSE @$ARG1 verify"
    CMDINFO echo "$CMD2" > /dev/tty; NORMAL
    #$CMD2
  fi

  shift $((OPTIND-1))


} #end function drushverify
